<ul>
  <li>How to set up Two Factor SSH with Google Authenticator (on CentOS 6)</li>
</ul>

<h4 id="download--install">Download &amp; Install</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@test ~]# yum install make gcc pam-devel
<span class="o">[</span>root@test ~]# yum install wget
<span class="o">[</span>root@test ~]# yum install ntp
<span class="o">[</span>root@test ~]# /etc/init.d/ntpd start
Starting ntpd:                                             <span class="o">[</span>  OK  <span class="o">]</span>
<span class="o">[</span>root@test ~]# chkconfig ntpd on
<span class="o">[</span>root@test ~]# <span class="nb">cd</span> /opt/
<span class="o">[</span>root@test opt]# wget https://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2
--2014-09-11 15:11:58--  https://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2
Resolving google-authenticator.googlecode.com... 173.194.72.82, 2404:6800:4008:c04::52
Connecting to google-authenticator.googlecode.com|173.194.72.82|:443... connected.
ERROR: cannot verify google-authenticator.googlecode.com’s certificate, issued by “/C<span class="o">=</span>KR/ST<span class="o">=</span>Seoul/L<span class="o">=</span>Seoul/~~~~~~~”:
  Unable to locally verify the issuer’s authority.
To connect to google-authenticator.googlecode.com insecurely, use ‘--no-check-certificate’.

<span class="c">## if you see above error, you need to use --no-check-certificate option </span>
<span class="o">[</span>root@test opt]# wget --no-check-certificate https://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2

<span class="o">[</span>root@test opt]# bzip2 -d libpam-google-authenticator-1.0-source.tar.bz2
<span class="o">[</span>root@test opt]# tar -xvf libpam-google-authenticator-1.0-source.tar
<span class="o">[</span>root@test opt]# <span class="nb">cd </span>libpam-google-authenticator-1.0
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# 
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# make
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# make install</code></pre></figure>

<p><br /></p>

<h4 id="set-up-google-authenticator">Set up Google Authenticator</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">- Run “google-authenticator” as the user you want to log <span class="k">in </span>with via SSH
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# su - ann
<span class="o">[</span>ann@test ~]<span class="nv">$ </span>google-authenticator
Do you want authentication tokens to be <span class="nb">time</span>-based <span class="o">(</span>y/n<span class="o">)</span> y
https://www.google.com/chart?chs<span class="o">=</span>200x200&amp;chld<span class="o">=</span>M|0&amp;cht<span class="o">=</span>qr&amp;chl<span class="o">=</span>otpauth://totp/ann@krbonstool01%3Fsecret%3DEFZSVUJOIT3373OR
Your new secret key is: EFZSVUJOIT3373OR
Your verification code is 343638
Your emergency scratch codes are:
  12537915
  43625506
  55016125
  81323386
  33075629
Do you want me to update your <span class="s2">"/home/ann/.google_authenticator"</span> file <span class="o">(</span>y/n<span class="o">)</span> y
Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks <span class="o">(</span>y/n<span class="o">)</span> y
By default, tokens are good <span class="k">for </span>30 seconds and <span class="k">in </span>order to compensate <span class="k">for
</span>possible <span class="nb">time</span>-skew between the client and the server, we allow an extra
token before and after the current time. If you experience problems with poor
<span class="nb">time </span>synchronization, you can increase the window from its default
size of 1:30min to about 4min. Do you want to <span class="k">do </span>so <span class="o">(</span>y/n<span class="o">)</span> y
If the computer that you are logging into is not hardened against brute-force
login attempts, you can <span class="nb">enable </span>rate-limiting <span class="k">for </span>the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to <span class="nb">enable </span>rate-limiting <span class="o">(</span>y/n<span class="o">)</span> y

- Open the URL and <span class="k">then </span>scan the QR code using the Google Authenticator application on your smartphone.</code></pre></figure>

<p><br /></p>

<h4 id="configuration">Configuration</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">- Enable Google authenticator <span class="k">for </span>SSH login
<span class="o">[</span>ann@test ~]<span class="nv">$ </span><span class="nb">exit
logout</span>
<span class="o">[</span>root@test ~]# 
<span class="o">[</span>root@test ~]# vi /etc/pam.d/sshd
<span class="c">## add below line on the top.</span>
auth       required     pam_google_authenticator.so


- Open the SSH configuration file and <span class="nb">set </span>to yes <span class="k">for</span> ‘ChallengeResponseAuthentication‘ line
<span class="o">[</span>root@test ~]# vi /etc/ssh/sshd_config
ChallengeResponseAuthentication yes


<span class="c">## restart sshd</span>
<span class="o">[</span>root@test ~]# service sshd restart
Stopping sshd:                                             <span class="o">[</span>  OK  <span class="o">]</span>
Starting sshd:                                             <span class="o">[</span>  OK  <span class="o">]</span></code></pre></figure>

<h4 id="note">NOTE</h4>

<ul>
  <li>
    <p>If you cannot login with Verification code, you need to check SELINUX setting.</p>
  </li>
  <li>
    <p>If SELINUX is set as enforcing, it should be changed to permissive or disabled</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@test ~]# vi /etc/selinux/config
<span class="nv">SELINUX</span><span class="o">=</span>permissive</code></pre></figure>

