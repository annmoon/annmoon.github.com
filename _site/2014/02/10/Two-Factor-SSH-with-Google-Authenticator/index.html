<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Two Factor SSH with Google Authenticator</title>
	<meta name="description" content="  How to set up Two Factor SSH with Google Authenticator (on CentOS 6)">
	
	<link rel="canonical" href="/2014/02/10/Two-Factor-SSH-with-Google-Authenticator/">
	<link rel="alternate" type="application/rss+xml" title="Ann Moon's Blog" href="/feed.xml" />
	
	<!-- <link rel="stylesheet" href="/css/main.css"> -->
    
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/index.css">
	<script type="text/javascript" src="/static/js/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/monokai_sublime.min.css">
	<script type="text/javascript" src="/static/js/highlight.min.js"></script>

    <!--
    <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css">
	<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.4/styles/monokai_sublime.min.css">
	<script type="text/javascript" src="http://apps.bdimg.com/libs/highlight.js/8.4/highlight.min.js"></script>
    -->
    
	<script type="text/javascript" src="/static/js/index.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>

 <!--  <body data-spy="scroll" data-target="#myAffix"> -->
  <body>

    <header>

<!-- navbar -->
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Ann Moon's Blog</a>
      <p class="navbar-text"></p>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">

        
          <li>
        
        <a href="/">Home</a></li>

        
          
            
              <li>
            
            <a href="/projects/"><span class="glyphicon "></span> Projects</a></li>
          
        
          
            
              <li>
            
            <a href="/about/"><span class="glyphicon "></span> About</a></li>
          
        
          
        
          
        
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

</header>

    <div id="main" class="container main">
      <div class="row">
  <div id="myArticle" class="col-sm-9">
    <div class="post-area post">
      <header>
        <h1>Two Factor SSH with Google Authenticator</h1>
        <p>Feb 10, 2014</p>
      </header>
      <hr>
      <article>
        <ul>
  <li>How to set up Two Factor SSH with Google Authenticator (on CentOS 6)</li>
</ul>

<h4 id="download--install">Download &amp; Install</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@test ~]# yum install make gcc pam-devel
<span class="o">[</span>root@test ~]# yum install wget
<span class="o">[</span>root@test ~]# yum install ntp
<span class="o">[</span>root@test ~]# /etc/init.d/ntpd start
Starting ntpd:                                             <span class="o">[</span>  OK  <span class="o">]</span>
<span class="o">[</span>root@test ~]# chkconfig ntpd on
<span class="o">[</span>root@test ~]# <span class="nb">cd</span> /opt/
<span class="o">[</span>root@test opt]# wget https://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2
--2014-09-11 15:11:58--  https://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2
Resolving google-authenticator.googlecode.com... 173.194.72.82, 2404:6800:4008:c04::52
Connecting to google-authenticator.googlecode.com|173.194.72.82|:443... connected.
ERROR: cannot verify google-authenticator.googlecode.com’s certificate, issued by “/C<span class="o">=</span>KR/ST<span class="o">=</span>Seoul/L<span class="o">=</span>Seoul/~~~~~~~”:
  Unable to locally verify the issuer’s authority.
To connect to google-authenticator.googlecode.com insecurely, use ‘--no-check-certificate’.

<span class="c">## if you see above error, you need to use --no-check-certificate option </span>
<span class="o">[</span>root@test opt]# wget --no-check-certificate https://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2

<span class="o">[</span>root@test opt]# bzip2 -d libpam-google-authenticator-1.0-source.tar.bz2
<span class="o">[</span>root@test opt]# tar -xvf libpam-google-authenticator-1.0-source.tar
<span class="o">[</span>root@test opt]# <span class="nb">cd </span>libpam-google-authenticator-1.0
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# 
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# make
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# make install</code></pre></figure>

<p><br /></p>

<h4 id="set-up-google-authenticator">Set up Google Authenticator</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">- Run “google-authenticator” as the user you want to log <span class="k">in </span>with via SSH
<span class="o">[</span>root@test libpam-google-authenticator-1.0]# su - ann
<span class="o">[</span>ann@test ~]<span class="nv">$ </span>google-authenticator
Do you want authentication tokens to be <span class="nb">time</span>-based <span class="o">(</span>y/n<span class="o">)</span> y
https://www.google.com/chart?chs<span class="o">=</span>200x200&amp;chld<span class="o">=</span>M|0&amp;cht<span class="o">=</span>qr&amp;chl<span class="o">=</span>otpauth://totp/ann@krbonstool01%3Fsecret%3DEFZSVUJOIT3373OR
Your new secret key is: EFZSVUJOIT3373OR
Your verification code is 343638
Your emergency scratch codes are:
  12537915
  43625506
  55016125
  81323386
  33075629
Do you want me to update your <span class="s2">"/home/ann/.google_authenticator"</span> file <span class="o">(</span>y/n<span class="o">)</span> y
Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks <span class="o">(</span>y/n<span class="o">)</span> y
By default, tokens are good <span class="k">for </span>30 seconds and <span class="k">in </span>order to compensate <span class="k">for
</span>possible <span class="nb">time</span>-skew between the client and the server, we allow an extra
token before and after the current time. If you experience problems with poor
<span class="nb">time </span>synchronization, you can increase the window from its default
size of 1:30min to about 4min. Do you want to <span class="k">do </span>so <span class="o">(</span>y/n<span class="o">)</span> y
If the computer that you are logging into is not hardened against brute-force
login attempts, you can <span class="nb">enable </span>rate-limiting <span class="k">for </span>the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to <span class="nb">enable </span>rate-limiting <span class="o">(</span>y/n<span class="o">)</span> y

- Open the URL and <span class="k">then </span>scan the QR code using the Google Authenticator application on your smartphone.</code></pre></figure>

<p><br /></p>

<h4 id="configuration">Configuration</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">- Enable Google authenticator <span class="k">for </span>SSH login
<span class="o">[</span>ann@test ~]<span class="nv">$ </span><span class="nb">exit
logout</span>
<span class="o">[</span>root@test ~]# 
<span class="o">[</span>root@test ~]# vi /etc/pam.d/sshd
<span class="c">## add below line on the top.</span>
auth       required     pam_google_authenticator.so


- Open the SSH configuration file and <span class="nb">set </span>to yes <span class="k">for</span> ‘ChallengeResponseAuthentication‘ line
<span class="o">[</span>root@test ~]# vi /etc/ssh/sshd_config
ChallengeResponseAuthentication yes


<span class="c">## restart sshd</span>
<span class="o">[</span>root@test ~]# service sshd restart
Stopping sshd:                                             <span class="o">[</span>  OK  <span class="o">]</span>
Starting sshd:                                             <span class="o">[</span>  OK  <span class="o">]</span></code></pre></figure>

<h4 id="note">NOTE</h4>

<ul>
  <li>
    <p>If you cannot login with Verification code, you need to check SELINUX setting.</p>
  </li>
  <li>
    <p>If SELINUX is set as enforcing, it should be changed to permissive or disabled</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@test ~]# vi /etc/selinux/config
<span class="nv">SELINUX</span><span class="o">=</span>permissive</code></pre></figure>


      </article>
      <hr>

        <script>
            window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    </div>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//annmoonsblog.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  </div>
  
  <div id="content" class="col-sm-3">
    <!-- <div id="myAffix" class="shadow-bottom-center hidden-xs" data-spy="affix" data-offset-top="0" data-offset-bottom="-20"> -->
    <div id="myAffix" class="shadow-bottom-center hidden-xs" >
      <div class="categories-list-header">
        Content
      </div>
      <div class="content-text"></div>
    </div>
  </div>
  
</div>

    </div>

    
    <div id="top" data-toggle="tooltip" data-placement="left" title="back to top">
      <a href="javascript:;">
        <div class="arrow"></div>
        <div class="stick"></div>
      </a>
    </div>

    <footer class="">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <a href="mailto:ann.moon2867@gmail.com"><span class="glyphicon glyphicon-envelope"></span> ann.moon2867@gmail.com</a>
        <span class="point"> · </span>
        
          <a href="https://github.com/annmoon">
            <span class="icon">
              <svg viewBox="0 0 16 16">
                <path fill="#aaa" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            Github
            <!-- <span>annmoon</span> -->
          </a>
          
          <span class="point"> · </span>
          <span><a href="https://github.com/annmoon/annmoon.github.io/blob/master/_posts/2014-02-10-Two-Factor-SSH-with-Google-Authenticator.md">View source</a></span>
          <span class="point"> · </span>
          <span><a class="newpost" href="javascript:;">New post</a></span>
		  <span class="point"> · </span>
          <span><a href="/feed.xml">RSS</a></span>
          <span class="point"> · </span>
          <span>&copy; 2015 LiXizhi</span>
      </div>
    </div>
  </div>
</footer>

    <script type="text/javascript">
    function OnClickNewPost()
    {
        var title = prompt("Please enter title of your post");
        if (title!=null){
            title = title.replace(" ", "-");
            var currentdate = new Date();
            var urlNewPage = "https://github.com/annmoon/annmoon.github.io/new/master?filename=_posts/" 
                + currentdate.getFullYear() + "-" + (currentdate.getMonth()+1) + "-" + currentdate.getDate() + "-" + title + ".md";
                
            var defaultText =  [
                '---',
                'layout: post',
                'comments: true',
                'categories: diary',
                '---',
                '## Title',
                'text'
                ].join('\n');
            urlNewPage += "&value=" + encodeURIComponent(defaultText);
            window.open(urlNewPage);
        }
    }
    
    $(function() {
      // CreateNewPostLinks
      $('.newpost').each(function(){
          $(this).click(OnClickNewPost);
      });
    });
</script>
  
  </body>
</html>
